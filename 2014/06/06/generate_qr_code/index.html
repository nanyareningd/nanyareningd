<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>javascript生成二维码(纯粹javascript代码，不依赖库，离线可用)</title>

    <meta name="author" content="陈佳伟">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/site/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/site/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/site/assets/themes/twitter/css/prettify.css" rel="stylesheet" type="text/css">
    <script src="/site/assets/themes/twitter/js/prettify.js"></script>    <script src="/site/assets/themes/twitter/js/scrollHandler.js" defer="true"></script>
    <!-- Le fav and touch icons -->
    <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/site/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/site/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    <!--    font-awesome-->
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

</head>

<body onload="prettyPrint()">
    <div class="navbar">
        <div class="navbar-inner">
            <div class="nav-narrow">
                <a class="brand" href="/site"><span class="fa fa-mortar-board (alias)">寂寞先生</span></a>
                <ul class="nav">









                    <li><a href="/site/archive.html">文章</a>
                    </li>










                    <li><a href="/site/categories.html">分类</a>
                    </li>










                    <li><a href="/site/pages.html">页面</a>
                    </li>










                    <li><a href="/site/tags.html">标签</a>
                    </li>







                </ul>
            </div>
        </div>
    </div>

    <div class="container-narrow">

        <div class="content">

            <!--
<div class="page-header">
  <h1>javascript生成二维码(纯粹javascript代码，不依赖库，离线可用) <small>Supporting tagline</small></h1>
</div>
-->


            <div class="row-fluid post-full">
                <div class="span12 ">
                    <div class="content card">
                        <div class="date_label">
                            <div class="day_month">
                                06/06
                            </div>
                            <div class="year">
                                2014
                            </div>
                        </div>
                        <h1>javascript生成二维码</h1>

                        <hr />
                        <div class="outer" style="min-height:150px;border:1px solid #eee;padding:4%;box-shadow:2px 2px 9px #eee;margin-bottom:300px;">
                            <form method="get" action="" style="float:left;">
                                <input type="text" id="QRstr" placeholder="输入要生成二维码的内容" class="input big text" value="" >
                                <input type="button" value="生成二维码" id="creatQRcode" class="big button" >
                            </form>
                            <div id="output" style="clear:both;"></div><br clear="all">
                            <div><a class="fa fa-github pull-right "
                            href="https://github.com/enml/project_demo/blob/master/generateQRCode.js">源码地址</a></div>
                        </div>
                        <br>
                        <p>二维码可以理解为一种信息标签，它将信息转化为二进制然后通过一定的规则进行编码形成几何图形，这样有利于机器识别。二维码在国内普通用户间的流行应该很大程度上归功于微信的推动，并且我发现很多人对二维码始终有着一种“不明觉厉”的感觉，不过假如我们理解了技术细节，便会知道事实上它就是一种信息格式转换，并没有什么神秘之处。</p>

                        <p>网上生成二维码的应用多如牛毛，但大多数都是基于服务端，今天我闲着想使用比较熟悉的javascript来实现一下，网上搜了一下发现还是挺多使用javascript来生成二维码的，但绝大多数甚至说我搜到的全部都是使用现成的库，比如jquery-qrcode、Google Chart API。使用库的好处就是快捷方便，但弊端就是你会像一个傻子一样什么原理细节都不懂，你只是把人家封装好的黑盒子拿过来，接上几根线就可以用了，但这个黑盒子里面到底是什么你都不知道。这就是为什么同样是程序员，有的人可以成为封装黑盒子的高级工程师，而有的人却当个苦逼的码农。</p>

                        <p>后来查找了一下ISO/IEC 18004:2006文档，足足100页的英文文档看的够呛了，不过说实话写的很详细条理很清晰，相信只要有耐心的人基本都能看懂它的实现原理。不过技术原理看懂了，不代表项目就实现了。编程的精髓并且也是最大的难点不在于语言本身，而是一种对客观事物进行抽象的思维能力；学会一门语言的语法很容易，有点基础的人学一门新语言基本一两天就搞定了，但仅仅只是语法是没有用的，能使用语言处理问题才是最重要的，把客观事物抽象处理是一件很费脑力的事情，我现在仍然感到很吃力。看完ISO/IEC 18004:2006文档我能清楚的理解二维码构造的原理，但要抽象成代码就很吃力了，网上不依赖库完全使用javascript实现的例子非常罕见，所以我花了几天最终才完成了这个小项目。</p>

                    </div>


                    <!--
    <ul class="tag_box inline ">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/site/categories.html#小项目-ref">
    		小项目 <span>2</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline ">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/site/tags.html#javascript-ref">javascript <span>23</span></a></li>
    
  



    </ul>
    -->

                    <div class="pagination clearfix">
                        <ul class="pull-right">

                            <li class="prev"><a class="fa fa-arrow-circle-left" href="/site/2014/05/27/HTTP-secure" title="HTTP协议安全"> 前一篇</a>
                            </li>

                            <li><a class="fa fa-th" href="/site/archive.html"> 所有日志</a>
                            </li>

                            <li class="next"><a href="/site/2014/06/12/js-scope" title="javascript作用域和声明提升">后一篇 <span class="fa fa-arrow-circle-right">  </span></a>
                            </li>

                        </ul>
                    </div>




                    <div id="disqus_thread"></div>
                    <script>
                        var QR_str = document.getElementById("QRstr"),
                            creatQR_btn = document.getElementById("creatQRcode"),
                            outputDiv = document.getElementById("output");
                        addEvent(QR_str, "mouseover", function () {
                            this.select();
                        });
                        var canvas = document.createElement('canvas'),
                            context;
                        context = canvas.getContext('2d');
                        if (context) {
                            addEvent(creatQR_btn, "click", function () {
                                var png = QRCode.generatePNG(QR_str.value);
                                outputDiv.innerHTML = "<img src=\'" + png + "\'>";
                            });
                        } else {
                            addEvent(creatQR_btn, "click", function () {
                                var table = QRCode.generateHTML(QR_str.value);
                                outputDiv.innerHTML = table;
                            });
                        };

                        function addEvent(ele, event, fn) {
                            if (document.addEventListener) {
                                ele.addEventListener(event, fn);
                            } else if (ele.attachEvent) {
                                ele.attachEvent("on" + event, fn);
                            } else {
                                ele["on" + event] = fn;
                            }
                        };


                        var QRCode = (function () {
                            var VERSIONS = [
 null,
 [[10, 7, 17, 13], [1, 1, 1, 1], []],
 [[16, 10, 28, 22], [1, 1, 1, 1], [4, 16]],
 [[26, 15, 22, 18], [1, 1, 2, 2], [4, 20]],
 [[18, 20, 16, 26], [2, 1, 4, 2], [4, 24]],
 [[24, 26, 22, 18], [2, 1, 4, 4], [4, 28]],
 [[16, 18, 28, 24], [4, 2, 4, 4], [4, 32]],
 [[18, 20, 26, 18], [4, 2, 5, 6], [4, 20, 36]],
 [[22, 24, 26, 22], [4, 2, 6, 6], [4, 22, 40]],
 [[22, 30, 24, 20], [5, 2, 8, 8], [4, 24, 44]],
 [[26, 18, 28, 24], [5, 4, 8, 8], [4, 26, 48]],
 [[30, 20, 24, 28], [5, 4, 11, 8], [4, 28, 52]],
 [[22, 24, 28, 26], [8, 4, 11, 10], [4, 30, 56]],
 [[22, 26, 22, 24], [9, 4, 16, 12], [4, 32, 60]],
 [[24, 30, 24, 20], [9, 4, 16, 16], [4, 24, 44, 64]],
 [[24, 22, 24, 30], [10, 6, 18, 12], [4, 24, 46, 68]],
 [[28, 24, 30, 24], [10, 6, 16, 17], [4, 24, 48, 72]],
 [[28, 28, 28, 28], [11, 6, 19, 16], [4, 28, 52, 76]],
 [[26, 30, 28, 28], [13, 6, 21, 18], [4, 28, 54, 80]],
 [[26, 28, 26, 26], [14, 7, 25, 21], [4, 28, 56, 84]],
 [[26, 28, 28, 30], [16, 8, 25, 20], [4, 32, 60, 88]],
 [[26, 28, 30, 28], [17, 8, 25, 23], [4, 26, 48, 70, 92]],
 [[28, 28, 24, 30], [17, 9, 34, 23], [4, 24, 48, 72, 96]],
 [[28, 30, 30, 30], [18, 9, 30, 25], [4, 28, 52, 76, 100]],
 [[28, 30, 30, 30], [20, 10, 32, 27], [4, 26, 52, 78, 104]],
 [[28, 26, 30, 30], [21, 12, 35, 29], [4, 30, 56, 82, 108]],
 [[28, 28, 30, 28], [23, 12, 37, 34], [4, 28, 56, 84, 112]],
 [[28, 30, 30, 30], [25, 12, 40, 34], [4, 32, 60, 88, 116]],
 [[28, 30, 30, 30], [26, 13, 42, 35], [4, 24, 48, 72, 96, 120]],
 [[28, 30, 30, 30], [28, 14, 45, 38], [4, 28, 52, 76, 100, 124]],
 [[28, 30, 30, 30], [29, 15, 48, 40], [4, 24, 50, 76, 102, 128]],
 [[28, 30, 30, 30], [31, 16, 51, 43], [4, 28, 54, 80, 106, 132]],
 [[28, 30, 30, 30], [33, 17, 54, 45], [4, 32, 58, 84, 110, 136]],
 [[28, 30, 30, 30], [35, 18, 57, 48], [4, 28, 56, 84, 112, 140]],
 [[28, 30, 30, 30], [37, 19, 60, 51], [4, 32, 60, 88, 116, 144]],
 [[28, 30, 30, 30], [38, 19, 63, 53], [4, 28, 52, 76, 100, 124, 148]],
 [[28, 30, 30, 30], [40, 20, 66, 56], [4, 22, 48, 74, 100, 126, 152]],
 [[28, 30, 30, 30], [43, 21, 70, 59], [4, 26, 52, 78, 104, 130, 156]],
 [[28, 30, 30, 30], [45, 22, 74, 62], [4, 30, 56, 82, 108, 134, 160]],
 [[28, 30, 30, 30], [47, 24, 77, 65], [4, 24, 52, 80, 108, 136, 164]],
 [[28, 30, 30, 30], [49, 25, 81, 68], [4, 28, 56, 84, 112, 140, 168]]];

                            var MODE_TERMINATOR = 0;
                            var MODE_NUMERIC = 1,
                                MODE_ALPHANUMERIC = 2,
                                MODE_OCTET = 4,
                                MODE_KANJI = 8;

                            // validation regexps
                            var NUMERIC_REGEXP = /^\d*$/;
                            var ALPHANUMERIC_REGEXP = /^[A-Za-z0-9 $%*+\-./:]*$/;
                            var ALPHANUMERIC_OUT_REGEXP = /^[A-Z0-9 $%*+\-./:]*$/;

                            var ECCLEVEL_L = 1,
                                ECCLEVEL_M = 0,
                                ECCLEVEL_Q = 3,
                                ECCLEVEL_H = 2;


                            var GF256_MAP = [],
                                GF256_INVMAP = [-1];
                            for (var i = 0, v = 1; i < 255; ++i) {
                                GF256_MAP.push(v);
                                GF256_INVMAP[v] = i;
                                v = (v * 2) ^ (v >= 128 ? 0x11d : 0);
                            }


                            var GF256_GENPOLY = [[]];
                            for (var i = 0; i < 30; ++i) {
                                var prevpoly = GF256_GENPOLY[i],
                                    poly = [];
                                for (var j = 0; j <= i; ++j) {
                                    var a = (j < i ? GF256_MAP[prevpoly[j]] : 0);
                                    var b = GF256_MAP[(i + (prevpoly[j - 1] || 0)) % 255];
                                    poly.push(GF256_INVMAP[a ^ b]);
                                }
                                GF256_GENPOLY.push(poly);
                            }

                            var ALPHANUMERIC_MAP = {};
                            for (var i = 0; i < 45; ++i) {
                                ALPHANUMERIC_MAP['0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:'.charAt(i)] = i;
                            }


                            var MASKFUNCS = [

 function (i, j) {
                                    return (i + j) % 2 == 0;
        },
 function (i, j) {
                                    return i % 2 == 0;
        },
 function (i, j) {
                                    return j % 3 == 0;
        },
 function (i, j) {
                                    return (i + j) % 3 == 0;
        },
 function (i, j) {
                                    return (((i / 2) | 0) + ((j / 3) | 0)) % 2 == 0;
        },
 function (i, j) {
                                    return (i * j) % 2 + (i * j) % 3 == 0;
        },
 function (i, j) {
                                    return ((i * j) % 2 + (i * j) % 3) % 2 == 0;
        },
 function (i, j) {
                                    return ((i + j) % 2 + (i * j) % 3) % 2 == 0;
        }];

                            var needsverinfo = function (ver) {
                                return ver > 6;
                            };
                            var getsizebyver = function (ver) {
                                return 4 * ver + 17;
                            };

                            var nfullbits = function (ver) {

                                var v = VERSIONS[ver];
                                var nbits = 16 * ver * ver + 128 * ver + 64; // finder, timing and format info.
                                if (needsverinfo(ver)) nbits -= 36; // version information
                                if (v[2].length) { // alignment patterns
                                    nbits -= 25 * v[2].length * v[2].length - 10 * v[2].length - 55;
                                }
                                return nbits;
                            };


                            var ndatabits = function (ver, ecclevel) {
                                var nbits = nfullbits(ver) & ~7;
                                var v = VERSIONS[ver];
                                nbits -= 8 * v[0][ecclevel] * v[1][ecclevel]; // ecc bits
                                return nbits;
                            }


                            var ndatalenbits = function (ver, mode) {
                                switch (mode) {
                                case MODE_NUMERIC:
                                    return (ver < 10 ? 10 : ver < 27 ? 12 : 14);
                                case MODE_ALPHANUMERIC:
                                    return (ver < 10 ? 9 : ver < 27 ? 11 : 13);
                                case MODE_OCTET:
                                    return (ver < 10 ? 8 : 16);
                                case MODE_KANJI:
                                    return (ver < 10 ? 8 : ver < 27 ? 10 : 12);
                                }
                            };

                            var getmaxdatalen = function (ver, mode, ecclevel) {
                                var nbits = ndatabits(ver, ecclevel) - 4 - ndatalenbits(ver, mode);
                                switch (mode) {
                                case MODE_NUMERIC:
                                    return ((nbits / 10) | 0) * 3 + (nbits % 10 < 4 ? 0 : nbits % 10 < 7 ? 1 : 2);
                                case MODE_ALPHANUMERIC:
                                    return ((nbits / 11) | 0) * 2 + (nbits % 11 < 6 ? 0 : 1);
                                case MODE_OCTET:
                                    return (nbits / 8) | 0;
                                case MODE_KANJI:
                                    return (nbits / 13) | 0;
                                }
                            };


                            var validatedata = function (mode, data) {
                                switch (mode) {
                                case MODE_NUMERIC:
                                    if (!data.match(NUMERIC_REGEXP)) return null;
                                    return data;

                                case MODE_ALPHANUMERIC:
                                    if (!data.match(ALPHANUMERIC_REGEXP)) return null;
                                    return data.toUpperCase();

                                case MODE_OCTET:
                                    if (typeof data === 'string') { // encode as utf-8 string
                                        var newdata = [];
                                        for (var i = 0; i < data.length; ++i) {
                                            var ch = data.charCodeAt(i);
                                            if (ch < 0x80) {
                                                newdata.push(ch);
                                            } else if (ch < 0x800) {
                                                newdata.push(0xc0 | (ch >> 6),
                                                    0x80 | (ch & 0x3f));
                                            } else if (ch < 0x10000) {
                                                newdata.push(0xe0 | (ch >> 12),
                                                    0x80 | ((ch >> 6) & 0x3f),
                                                    0x80 | (ch & 0x3f));
                                            } else {
                                                newdata.push(0xf0 | (ch >> 18),
                                                    0x80 | ((ch >> 12) & 0x3f),
                                                    0x80 | ((ch >> 6) & 0x3f),
                                                    0x80 | (ch & 0x3f));
                                            }
                                        }
                                        return newdata;
                                    } else {
                                        return data;
                                    }
                                }
                            };


                            var encode = function (ver, mode, data, maxbuflen) {
                                var buf = [];
                                var bits = 0,
                                    remaining = 8;
                                var datalen = data.length;

                                var pack = function (x, n) {
                                    if (n >= remaining) {
                                        buf.push(bits | (x >> (n -= remaining)));
                                        while (n >= 8) buf.push((x >> (n -= 8)) & 255);
                                        bits = 0;
                                        remaining = 8;
                                    }
                                    if (n > 0) bits |= (x & ((1 << n) - 1)) << (remaining -= n);
                                };

                                var nlenbits = ndatalenbits(ver, mode);
                                pack(mode, 4);
                                pack(datalen, nlenbits);

                                switch (mode) {
                                case MODE_NUMERIC:
                                    for (var i = 2; i < datalen; i += 3) {
                                        pack(parseInt(data.substring(i - 2, i + 1), 10), 10);
                                    }
                                    pack(parseInt(data.substring(i - 2), 10), [0, 4, 7][datalen % 3]);
                                    break;

                                case MODE_ALPHANUMERIC:
                                    for (var i = 1; i < datalen; i += 2) {
                                        pack(ALPHANUMERIC_MAP[data.charAt(i - 1)] * 45 +
                                            ALPHANUMERIC_MAP[data.charAt(i)], 11);
                                    }
                                    if (datalen % 2 == 1) {
                                        pack(ALPHANUMERIC_MAP[data.charAt(i - 1)], 6);
                                    }
                                    break;

                                case MODE_OCTET:
                                    for (var i = 0; i < datalen; ++i) {
                                        pack(data[i], 8);
                                    }
                                    break;
                                };


                                pack(MODE_TERMINATOR, 4);
                                if (remaining < 8) buf.push(bits);


                                while (buf.length + 1 < maxbuflen) buf.push(0xec, 0x11);
                                if (buf.length < maxbuflen) buf.push(0xec);
                                return buf;
                            };


                            var calculateecc = function (poly, genpoly) {
                                var modulus = poly.slice(0);
                                var polylen = poly.length,
                                    genpolylen = genpoly.length;
                                for (var i = 0; i < genpolylen; ++i) modulus.push(0);
                                for (var i = 0; i < polylen;) {
                                    var quotient = GF256_INVMAP[modulus[i++]];
                                    if (quotient >= 0) {
                                        for (var j = 0; j < genpolylen; ++j) {
                                            modulus[i + j] ^= GF256_MAP[(quotient + genpoly[j]) % 255];
                                        }
                                    }
                                }
                                return modulus.slice(polylen);
                            };


                            var augumenteccs = function (poly, nblocks, genpoly) {
                                var subsizes = [];
                                var subsize = (poly.length / nblocks) | 0,
                                    subsize0 = 0;
                                var pivot = nblocks - poly.length % nblocks;
                                for (var i = 0; i < pivot; ++i) {
                                    subsizes.push(subsize0);
                                    subsize0 += subsize;
                                }
                                for (var i = pivot; i < nblocks; ++i) {
                                    subsizes.push(subsize0);
                                    subsize0 += subsize + 1;
                                }
                                subsizes.push(subsize0);

                                var eccs = [];
                                for (var i = 0; i < nblocks; ++i) {
                                    eccs.push(calculateecc(poly.slice(subsizes[i], subsizes[i + 1]), genpoly));
                                }

                                var result = [];
                                var nitemsperblock = (poly.length / nblocks) | 0;
                                for (var i = 0; i < nitemsperblock; ++i) {
                                    for (var j = 0; j < nblocks; ++j) {
                                        result.push(poly[subsizes[j] + i]);
                                    }
                                }
                                for (var j = pivot; j < nblocks; ++j) {
                                    result.push(poly[subsizes[j + 1] - 1]);
                                }
                                for (var i = 0; i < genpoly.length; ++i) {
                                    for (var j = 0; j < nblocks; ++j) {
                                        result.push(eccs[j][i]);
                                    }
                                }
                                return result;
                            };


                            var augumentbch = function (poly, p, genpoly, q) {
                                var modulus = poly << q;
                                for (var i = p - 1; i >= 0; --i) {
                                    if ((modulus >> (q + i)) & 1) modulus ^= genpoly << i;
                                }
                                return (poly << q) | modulus;
                            };


                            var makebasematrix = function (ver) {
                                var v = VERSIONS[ver],
                                    n = getsizebyver(ver);
                                var matrix = [],
                                    reserved = [];
                                for (var i = 0; i < n; ++i) {
                                    matrix.push([]);
                                    reserved.push([]);
                                }

                                var blit = function (y, x, h, w, bits) {
                                    for (var i = 0; i < h; ++i) {
                                        for (var j = 0; j < w; ++j) {
                                            matrix[y + i][x + j] = (bits[i] >> j) & 1;
                                            reserved[y + i][x + j] = 1;
                                        }
                                    }
                                };

                                // finder patterns and a part of timing patterns
                                blit(0, 0, 9, 9, [0x7f, 0x41, 0x5d, 0x5d, 0x5d, 0x41, 0x17f, 0x00, 0x40]);
                                blit(n - 8, 0, 8, 9, [0x100, 0x7f, 0x41, 0x5d, 0x5d, 0x5d, 0x41, 0x7f]);
                                blit(0, n - 8, 9, 8, [0xfe, 0x82, 0xba, 0xba, 0xba, 0x82, 0xfe, 0x00, 0x00]);

                                // the rest of timing patterns
                                for (var i = 9; i < n - 8; ++i) {
                                    matrix[6][i] = matrix[i][6] = ~i & 1;
                                    reserved[6][i] = reserved[i][6] = 1;
                                }

                                // alignment patterns
                                var aligns = v[2],
                                    m = aligns.length;
                                for (var i = 0; i < m; ++i) {
                                    var minj = (i == 0 || i == m - 1 ? 1 : 0),
                                        maxj = (i == 0 ? m - 1 : m);
                                    for (var j = minj; j < maxj; ++j) {
                                        blit(aligns[i], aligns[j], 5, 5, [0x1f, 0x11, 0x15, 0x11, 0x1f]);
                                    }
                                }

                                // version information
                                if (needsverinfo(ver)) {
                                    var code = augumentbch(ver, 6, 0x1f25, 12);
                                    var k = 0;
                                    for (var i = 0; i < 6; ++i) {
                                        for (var j = 0; j < 3; ++j) {
                                            matrix[i][(n - 11) + j] = matrix[(n - 11) + j][i] = (code >> k++) & 1;
                                            reserved[i][(n - 11) + j] = reserved[(n - 11) + j][i] = 1;
                                        }
                                    }
                                }

                                return {
                                    matrix: matrix,
                                    reserved: reserved
                                };
                            };


                            var putdata = function (matrix, reserved, buf) {
                                var n = matrix.length;
                                var k = 0,
                                    dir = -1;
                                for (var i = n - 1; i >= 0; i -= 2) {
                                    if (i == 6)--i; // skip the entire timing pattern column
                                    var jj = (dir < 0 ? n - 1 : 0);
                                    for (var j = 0; j < n; ++j) {
                                        for (var ii = i; ii > i - 2; --ii) {
                                            if (!reserved[jj][ii]) {
                                                matrix[jj][ii] = (buf[k >> 3] >> (~k & 7)) & 1;
                                                ++k;
                                            }
                                        }
                                        jj += dir;
                                    }
                                    dir = -dir;
                                }
                                return matrix;
                            };


                            var maskdata = function (matrix, reserved, mask) {
                                var maskf = MASKFUNCS[mask];
                                var n = matrix.length;
                                for (var i = 0; i < n; ++i) {
                                    for (var j = 0; j < n; ++j) {
                                        if (!reserved[i][j]) matrix[i][j] ^= maskf(i, j);
                                    }
                                }
                                return matrix;
                            }

                            // puts the format information.
                            var putformatinfo = function (matrix, reserved, ecclevel, mask) {
                                var n = matrix.length;
                                var code = augumentbch((ecclevel << 3) | mask, 5, 0x537, 10) ^ 0x5412;
                                for (var i = 0; i < 15; ++i) {
                                    var r = [0, 1, 2, 3, 4, 5, 7, 8, n - 7, n - 6, n - 5, n - 4, n - 3, n - 2, n - 1][i];
                                    var c = [n - 1, n - 2, n - 3, n - 4, n - 5, n - 6, n - 7, n - 8, 7, 5, 4, 3, 2, 1, 0][i];
                                    matrix[r][8] = matrix[8][c] = (code >> i) & 1;

                                }
                                return matrix;
                            };


                            var evaluatematrix = function (matrix) {

                                var PENALTY_CONSECUTIVE = 3;

                                var PENALTY_TWOBYTWO = 3;

                                var PENALTY_FINDERLIKE = 40;

                                var PENALTY_DENSITY = 10;

                                var evaluategroup = function (groups) {
                                    var score = 0;
                                    for (var i = 0; i < groups.length; ++i) {
                                        if (groups[i] >= 5) score += PENALTY_CONSECUTIVE + (groups[i] - 5);
                                    }
                                    for (var i = 5; i < groups.length; i += 2) {
                                        var p = groups[i];
                                        if (groups[i - 1] == p && groups[i - 2] == 3 * p && groups[i - 3] == p &&
                                            groups[i - 4] == p && (groups[i - 5] >= 4 * p || groups[i + 1] >= 4 * p)) {
                                            score += PENALTY_FINDERLIKE;
                                        }
                                    }
                                    return score;
                                };

                                var n = matrix.length;
                                var score = 0,
                                    nblacks = 0;
                                for (var i = 0; i < n; ++i) {
                                    var row = matrix[i];
                                    var groups;

                                    groups = [0];
                                    for (var j = 0; j < n;) {
                                        var k;
                                        for (k = 0; j < n && row[j]; ++k)++j;
                                        groups.push(k);
                                        for (k = 0; j < n && !row[j]; ++k)++j;
                                        groups.push(k);
                                    }
                                    score += evaluategroup(groups);

                                    groups = [0];
                                    for (var j = 0; j < n;) {
                                        var k;
                                        for (k = 0; j < n && matrix[j][i]; ++k)++j;
                                        groups.push(k);
                                        for (k = 0; j < n && !matrix[j][i]; ++k)++j;
                                        groups.push(k);
                                    }
                                    score += evaluategroup(groups);

                                    var nextrow = matrix[i + 1] || [];
                                    nblacks += row[0];
                                    for (var j = 1; j < n; ++j) {
                                        var p = row[j];
                                        nblacks += p;
                                        if (row[j - 1] == p && nextrow[j] === p && nextrow[j - 1] === p) {
                                            score += PENALTY_TWOBYTWO;
                                        }
                                    }
                                }

                                score += PENALTY_DENSITY * ((Math.abs(nblacks / n / n - 0.5) / 0.05) | 0);
                                return score;
                            };


                            var generate = function (data, ver, mode, ecclevel, mask) {
                                var v = VERSIONS[ver];
                                var buf = encode(ver, mode, data, ndatabits(ver, ecclevel) >> 3);
                                buf = augumenteccs(buf, v[1][ecclevel], GF256_GENPOLY[v[0][ecclevel]]);

                                var result = makebasematrix(ver);
                                var matrix = result.matrix,
                                    reserved = result.reserved;
                                putdata(matrix, reserved, buf);

                                if (mask < 0) {
                                    maskdata(matrix, reserved, 0);
                                    putformatinfo(matrix, reserved, ecclevel, 0);
                                    var bestmask = 0,
                                        bestscore = evaluatematrix(matrix);
                                    maskdata(matrix, reserved, 0);
                                    for (mask = 1; mask < 8; ++mask) {
                                        maskdata(matrix, reserved, mask);
                                        putformatinfo(matrix, reserved, ecclevel, mask);
                                        var score = evaluatematrix(matrix);
                                        if (bestscore > score) {
                                            bestscore = score;
                                            bestmask = mask;
                                        }
                                        maskdata(matrix, reserved, mask);
                                    }
                                    mask = bestmask;
                                }

                                maskdata(matrix, reserved, mask);
                                putformatinfo(matrix, reserved, ecclevel, mask);
                                return matrix;
                            };


                            var QRCode = {
                                'generate': function (data, options) {
                                    var MODES = {
                                        'numeric': MODE_NUMERIC,
                                        'alphanumeric': MODE_ALPHANUMERIC,
                                        'octet': MODE_OCTET
                                    };
                                    var ECCLEVELS = {
                                        'L': ECCLEVEL_L,
                                        'M': ECCLEVEL_M,
                                        'Q': ECCLEVEL_Q,
                                        'H': ECCLEVEL_H
                                    };

                                    options = options || {};
                                    var ver = 3;
                                    var ecclevel = ECCLEVELS["Q"];
                                    var mode = -1;
                                    var mask = -1;

                                    if (mode < 0) {
                                        if (typeof data === 'string') {
                                            if (data.match(NUMERIC_REGEXP)) {
                                                mode = MODE_NUMERIC;
                                            } else if (data.match(ALPHANUMERIC_OUT_REGEXP)) {
                                                mode = MODE_ALPHANUMERIC;
                                            } else {
                                                mode = MODE_OCTET;
                                            }
                                        } else {
                                            mode = MODE_OCTET;
                                        }
                                    } else if (!(mode == MODE_NUMERIC || mode == MODE_ALPHANUMERIC ||
                                        mode == MODE_OCTET)) {
                                        throw '暂时不支持你所输入的内容格式';
                                    }

                                    data = validatedata(mode, data);
                                    if (data === null) throw '请输入内容';

                                    if (ecclevel < 0 || ecclevel > 3) throw 'ecc错误纠正级别有误';

                                    if (ver < 0) {
                                        for (ver = 1; ver <= 40; ++ver) {
                                            if (data.length <= getmaxdatalen(ver, mode, ecclevel)) break;
                                        }
                                        if (ver > 40) throw '数据太大';
                                    } else if (ver < 1 || ver > 40) {
                                        throw 'invalid version';
                                    }

                                    if (mask != -1 && (mask < 0 || mask > 8)) throw 'invalid mask';

                                    return generate(data, ver, mode, ecclevel, mask);
                                },

                                'generateHTML': function (data, options) {
                                    options = options || {};
                                    var matrix = QRCode['generate'](data, options);
                                    var modsize = 7;
                                    var margin = 2;

                                    var e = document.createElement('div');
                                    var n = matrix.length;
                                    var html = ['<table border="0" cellspacing="0" cellpadding="0" style="border:' +
   modsize * margin + 'px solid #fff;background:#fff">'];
                                    for (var i = 0; i < n; ++i) {
                                        html.push('<tr>');
                                        for (var j = 0; j < n; ++j) {
                                            html.push('<td style="width:' + modsize + 'px;height:' + modsize + 'px' +
                                                (matrix[i][j] ? ';background:#000' : '') + '"></td>');
                                        }
                                        html.push('</tr>');
                                    }
                                    e.className = 'qrcode';
                                    e.innerHTML = html.join('') + '</table>';
                                    return e;
                                },

                                'generatePNG': function (data, options) {
                                    options = options || {};
                                    var matrix = QRCode['generate'](data, options);
                                    var modsize = 10;
                                    var margin = 2;
                                    var n = matrix.length;
                                    var size = modsize * (n + 2 * margin);

                                    var canvas = document.createElement('canvas'),
                                        context;
                                    canvas.width = canvas.height = size;
                                    context = canvas.getContext('2d');
                                    if (!context) throw '你的浏览器不支持canvas，无法生成二维码';

                                    context.fillStyle = '#fff';
                                    context.fillRect(0, 0, size, size);
                                    context.fillStyle = '#db4949';
                                    for (var i = 0; i < n; ++i) {
                                        for (var j = 0; j < n; ++j) {
                                            if (matrix[i][j]) {
                                                context.fillRect(modsize * (margin + j),
                                                    modsize * (margin + i),
                                                    modsize, modsize);
                                            }
                                        }
                                    }
                                    return canvas.toDataURL();
                                }
                            };

                            return QRCode;
                        })();
                    </script>
                    <script type="text/javascript">
                        var disqus_developer = 1;
                        var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname

                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function () {
                            var dsq = document.createElement('script');
                            dsq.type = 'text/javascript';
                            dsq.async = true;
                            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
                    </noscript>
                    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




                </div>
            </div>


        </div>

        <footer class="card clearfix">
            <span style="font-size:30px;" class="fa fa-github pull-left"></span><a href="https://github.com/enml/blog/tree/jekyll-blog" style="display:inline-block;padding-right:80px;border-right:1px solid #bbb">fork me on GitHub</a>
            <p class="pull-right">&copy; 2011 陈佳伟 with help from <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
            </p>

        </footer>

    </div>


</body>

</html>

